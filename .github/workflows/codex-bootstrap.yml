name: ü§ñ Codex Bootstrap and Cleanup Workflow

on:
  workflow_dispatch:

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß† Generate Codex Cleanup workflow
        run: |
          mkdir -p .github/workflows
          cat << 'EOF' > .github/workflows/codex-cleanup.yml
          name: üßπ Codex Cleanup PRs

          on:
            workflow_dispatch:

          jobs:
            cleanup:
              runs-on: ubuntu-latest
              permissions:
                contents: write
                pull-requests: write

              steps:
                - name: üß© Checkout repo
                  uses: actions/checkout@v4

                - name: üß† Close old Codex PRs
                  env:
                    GH_TOKEN: \${{ secrets.GITHUB_TOKEN }}
                  run: |
                    echo "üîç Searching for old Codex PRs..."
                    prs=$(gh pr list --state open --json number,title | jq -r '.[] | select(.title | test("Codex|auto|fix|xlsx|parser|upload"; "i")) | .number')
                    for pr in $prs; do
                      echo "‚ùå Closing PR #$pr..."
                      gh pr close $pr --delete-branch --comment "Auto-closed by Codex Cleanup"
                    done
                    echo "‚úÖ All old Codex PRs closed successfully!"

                - name: üß† Create new clean branch
                  run: |
                    git config --global user.email "codex@dsdgroup.es"
                    git config --global user.name "Codex Cleanup Bot"
                    git fetch origin main
                    git checkout main
                    git pull
                    git checkout -b codex/fresh-clean-state
                    git push origin codex/fresh-clean-state
                    gh pr create --base main --head codex/fresh-clean-state --title "üß† Codex Fresh State PR" --body "Reinitialized clean state after automatic cleanup."
          EOF

      - name: üöÄ Commit & Push via Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Codex Bootstrap Bot"
          git config --global user.email "codex@dsdgroup.es"
          git checkout -b codex/add-cleanup-workflow
          git add .github/workflows/codex-cleanup.yml
          git commit -m "üß† add Codex Cleanup workflow"
          git push origin codex/add-cleanup-workflow
          gh pr create --base main --head codex/add-cleanup-workflow --title "üß† Add Codex Cleanup Workflow" --body "Bootstrap automatically created Codex cleanup workflow."
