name: ðŸ¤– Codex Bootstrap Setup

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§  Create Cleanup Workflow
        run: |
          mkdir -p .github/workflows
          echo 'name: ðŸ§¹ Codex Cleanup PRs

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§  Close old Codex PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Searching for old Codex PRs..."
          prs=$(gh pr list --state open --json number,title | jq -r \'.[] | select(.title | test("Codex|auto|fix|xlsx|parser|upload"; "i")) | .number\')
          for pr in $prs; do
            echo "âŒ Closing PR #$pr..."
            gh pr close $pr --delete-branch --comment "Auto-closed by Codex Cleanup"
          done
          echo "âœ… All old Codex PRs closed successfully!"

      - name: ðŸ§  Create new clean branch
        run: |
          git config --global user.email "codex@dsdgroup.es"
          git config --global user.name "Codex Cleanup Bot"
          git fetch origin main
          git checkout main
          git pull
          git checkout -b codex/fresh-clean-state
          git push origin codex/fresh-clean-state
          gh pr create --base main --head codex/fresh-clean-state --title "ðŸ§  Codex Fresh State PR" --body "Reinitialized clean state after automatic cleanup."' > .github/workflows/codex-cleanup.yml

      - name: ðŸš€ Commit and push cleanup workflow
        run: |
          git config --global user.email "codex@dsdgroup.es"
          git config --global user.name "Codex Bootstrap Bot"
          git add .github/workflows/codex-cleanup.yml
          git commit -m "ðŸš€ bootstrap: add Codex cleanup workflow" || echo "No changes to commit"
          git push
