name: ğŸ§  Codex Autodidact Maintenance


on:
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches:
      - main
      - codex/*
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  codex-maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: âš™ï¸ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install prettier eslint js-yaml supabase --legacy-peer-deps || true

      - name: ğŸ§  Run Codex Autodidact Maintenance
        run: |
          echo "ğŸš€ Running Codex Self-Repair & Learning..."
          if [ -f "scripts/codex-autodidact-maintenance.js" ]; then
            node scripts/codex-autodidact-maintenance.js || echo "âš ï¸ Maintenance script completed with warnings."
          else
            echo "âŒ codex-autodidact-maintenance.js not found in scripts/. Exiting."
            exit 1
          fi

      - name: ğŸ§  Codex Bankinter Self-Learning
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸš€ Executando Codex Bankinter Self-Learning..."
          if [ -z "${NEXT_PUBLIC_SUPABASE_URL}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY}" ]; then
            echo "âš ï¸ VariÃ¡veis do Supabase ausentes. Pulando etapa de upload Bankinter."
            exit 0
          fi

          if [ -f "scripts/codex-bankinter-self-learning.js" ]; then
            node scripts/codex-bankinter-self-learning.js || echo "âš ï¸ Bankinter self-learning retornou aviso."
          else
            echo "âŒ scripts/codex-bankinter-self-learning.js nÃ£o encontrado."
            exit 1
          fi

      - name: ğŸ§¾ Commit any changes (if present)
        run: |
          echo "ğŸ” Checking for changes..."
          git config user.name "Codex Autodidact Bot"
          git config user.email "codex@dsdgroup.es"
          git add .
          if git diff --cached --quiet; then
            echo "âœ… No changes detected."
          else
            echo "ğŸ§© Committing changes..."
            git commit -m "ğŸ¤– Codex Maintenance: self-learning and workflow sync" || echo "âš ï¸ Commit skipped."
          fi

      - name: ğŸš€ Create or update PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: codex/auto-maintenance
          title: "ğŸ§  Codex Self-Learning Maintenance Run"
          body: |
            ğŸ¤– **Codex Autonomous Maintenance Summary**

            This PR was generated automatically and includes:
            - ğŸ§¹ Self-repair and structure cleanup
            - ğŸ§© Workflow & Supabase validation
            - ğŸ¨ Code formatting and linting
            - ğŸ§  Machine-learning pattern updates

            _Generated by Codex Autodidact AI_
          commit-message: "ğŸ¤– Codex Maintenance: self-learning and workflow sync"
          delete-branch: true
